<link rel="import" href="webda-core.html">
<script>
    Webda.Behaviors.Store = {

      properties: {
      	model: {
      		type: Object,
      		value: {}
      	},
      	uuid: {
      		type: String,
                  observer: 'get'
      	},
            store: {
                  type: String
            }
      },

      save: function() {
            if (this.store === undefined) return;
            var event = '';
            if (this.model.uuid) {
                  event = 'Webda.Store.Update';
                  Webda.ajax.method = 'PUT';
                  Webda.ajax.url = Webda.url(this.store.toLowerCase() + '/' + this.uuid);
            } else {
                  event = 'Webda.Store.Create';
                  Webda.ajax.method = 'POST';
                  Webda.ajax.url = Webda.url(this.store.toLowerCase());
            }
            Webda.ajax.contentType = 'application/json';
            Webda.ajax.body = this.model;
            return Webda.ajax.generateRequest().completes.then((req) => {
                  this.fire(event, this.model);
                  return Promise.resolve();
            });
      },

      ready: function() {
            if (this.uuid && this.store) {
                  this.get();
            }
      },

      get: function() {
            if (this.store === undefined || this.uuid === undefined || this._promise) return;
            Webda.ajax.method = 'GET';
            Webda.ajax.url = Webda.url(this.store.toLowerCase() + '/' + this.uuid);
            this._promise = Webda.ajax.generateRequest().completes.then((req) => {
                  this.model = req.response;
                  this._promise = undefined;
            });
            return this._promise;
      },
      
      delete: function() {
            if (this.store === undefined) return;
            if (this.uuid === undefined) {
                  this.fire('Webda.Store.Delete', this.model);
                  return;
            }
            Webda.ajax.method = 'DELETE';
            Webda.ajax.url = Webda.url(this.store.toLowerCase() + '/' + this.uuid);
            return Webda.ajax.generateRequest().completes.then(() => {
                  this.fire('Webda.Store.Delete', this.model);
            });
      }
    };

</script>